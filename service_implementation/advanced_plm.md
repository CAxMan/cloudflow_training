# Beyond just files: Using PLM for versioning and metadata

## GSS

PLM server has its own implementation of GSS services. GSS has SOAP and REST services.
WSDL (SOAP): https://caxman.clesgo.net/jotne/GSS/FileWebService?wsdl
REST end point: https://caxman.clesgo.net/jotne/GSS/resources/plm

GSS covers is small subset of simplified methods (services) of PLM server.

Java (Maven) client: https://github.com/CAxMan/PlmGSS-samples

PLM server is also accessible via GSS implementation by SINTEF.
Code samples: https://github.com/CAxMan/infrastructureClients/tree/master/gssClients

PLM has some extra methods (SOAP) exposed via GSS
- *createFolderVersion*
- *listFolderVersions*
- *listFileVersions*
- *plm2gss*
- *gss2plm*

**createFolderVersion** - creates new version of a specifies folder. Children folders are reused. Files are copied.
Parameters:
- **folderID** - GSS folder id of a folder to create new version from. Example: plm://InitialRepository/Ultralight_Glider/236223201541
- **session_id** - Keystone authentication token
Returns: **ResourceInformation** object with GSS folder ID of just create folder version

**listFolderVersions** - lists all versions of a specified folder including the one specified
Parameters:
- **path** - GSS folder id. Example: plm://InitialRepository/Ultralight_Glider/236223201541
- **session_id** - Keystone authentication token
Returns: **ResourceInformation** object for each folder version

**listFileVersions** - lists all versions of a specified folder including the one specified
Parameters:
- **path** - GSS file id. Example: plm://InitialRepository/Ultralight_Glider/236223201541
- **session_id** - Keystone authentication token
Returns: **ResourceInformation** object for each file version

Following two methods can be used to switch between GSS and PLM native services.
GSS uses object identifiers like the following.
"plm://TestRepository/MyModel123/1234567890"
where last part (integer value) is PLM identifier.

**plm2gss** - converts PLM object identifier to GSS identifier

Example:
```Java
String keystoneToken = ...
V_node node = ...
ResourceInformation folderId = srv.plm2Gss(node.getNodus().getItem().getInstance_id(), keystoneToken);
String id = folderId.getUniqueName();
```

**gss2plm** - converts GSS identifier to PLM object identifier

Example:
```Java
String keystoneToken = ...
FileWebService_PortType srv = new FileWebService_ServiceLocator().getFileWebServicePort();
PlmResource plmId = srv.gss2Plm("plm://TestRepository/MyModel123/1234567890", keystoneToken);

String wsdl = plmId.getWsdlUrl();
String serviceUrl = plmId.getServiceUrl();
```

## Native services (SOAP)

Java (Maven) client: https://github.com/CAxMan/plm_soap_samples
Note, all code samples below are in Java. Java classes are generated by "axistools-maven-plugin" (version 1.4) from WSDL documents.

### Authentication in PLM database

There is group of SOAP services (Access) to perform authentication in PLM database
WSDL: https://caxman.clesgo.net/jotne/EDMWS/WSDLGenerator?accesscontrol=yes&user=simdm_user&password=db&option=LITERAL_ENCODING

The following methods from the Access group of services could use useful.
- **login** - to obtain session identifier that is used in any other services at one of parameters.
- **logout** - to close existing session. Existing session is closed automatically in 12 hours if no any services are called.

Example:
```Java
EDMAccessControlServiceLocator edmAccessControlServiceLocator = new EDMAccessControlServiceLocator();
String server = "https://caxman.clesgo.net/jotne";
EDMAccessControl edmAccessControl = edmAccessControlServiceLocator.getEDMWS(new URL(server + "/EDMWS/AccessControl?option=LITERAL_ENCODING"));
...
// login - can be valid Keystone token
// password - any not empty value in case of using valid Keystone token
// Keystone token works if corresponding user name is registered in PLM database
String sessionID = edmAccessControl.login("login", "sdai-group", "password");
...
String closeResult = edmAccessControl.logout(sessionID);
```

### Repositories and models

One more group of services (Config) has methods to handle repositories and models in PLM database.
WSDL: https://caxman.clesgo.net/jotne/EDMWS/WSDLGenerator?user=simdm_user&password=db&repository=SimDM_system&model=Config&schema=SimDM_config&querySchema=SimDM_config_support&option=LITERAL_ENCODING

Get available repositories and models:
```Java
SimDM_config_supportServiceLocator supportServiceLocator = new SimDM_config_supportServiceLocator();
SimDM_config_support configService = supportServiceLocator.getEDMWS();
...
V_repository[] repositories = configService.repository_list(sessionID); // sessionID - session identifier got from login method
```

Now required repository and model can be found by name
```Java
V_repository repo = null;
if (repositories != null) {
   for (V_repository r : repositories) {
       if ("name_you_are_looking".equals(r.getName())) {
           repo = r; // repository is found
           break;
       }
   }
}
```

Repository may contain multiple models. Required model can be found by name
```Java
V_model model = null;
V_model[] models = repo.getModels();
if (models != null) {
   for (V_model m : models) {
       if ("name_you_are_looking".equals(m.getName())) {
           model = m; // model is found
           break;
       }
   }
}
```

Repository or model can be deleted.
Note, To delete repository all models within repository should be deleted first.
```Java
configService.delete_model(sessionID, repo.getName(), model.getName(), null);
configService.delete_repository(sessionID, repo.getName());
```

If required repository or model is not yet exist, it can be created.
Note, repository name should start with letter followed by letters, digits and underscore symbols.
It is not possible to create multiple repositories if only case of letters is different.
Model name should be unique within repository. Model name has the same restrictions as repository name.
```Java
V_repository repo = configService.create_repository(sessionID, "repository_name", "description text");
V_model model = configService.create_model(sessionID, repo.getName(), "model_Name", "description text here", "PROJECT"); // "PROJECT" - default value in GSS
```

### Product structure

One more group of services (SimDMMaster) has methods to handle product structure (folders, files, etc.) in PLM database.
WSDL: https://caxman.clesgo.net/jotne/EDMWS/WSDLGenerator?user=simdm_user&password=db&repository=SimDM_system&model=user_management&schema=SIMDM_MASTER&querySchema=SIMDM_MASTER_WSDL&option=LITERAL_ENCODING

Note, the WSDL above is to work with one specific model in specific repository.
Repository and model name is in the URL
Repository name: SimDM_system
Model name: user_management

The model "user_namagement" is special model that is used as a library of available database users.

It is enough to generate client stub classes for one model.
Generated classes can be used to work with product structures within different repositories and models.
```Java
String server = "https://caxman.clesgo.net/jotne";

String repoName = "TestRepository";
String modelName = "existing_model_name";

String url = String.format("%s/EDMWS/earlybinding/options_2097152/%s/%s/QEX/SIMDM_MASTER_WSDL", server, repoName, modelName);
SIMDM_MASTER_WSDL simDmService = simDmMasterServiceLocator.getEDMWS(new URL(url));
```

Product structure must be defined in just created model.
```Java
V_item item = new V_item();
item.setDescription("");
item.setIntroduced("");
item.setItem_type("PROJECT"); // can be one from list: simDmService.pbs_list_types(sessionID); 
item.setLast_changed("");
item.setName("root"); // Root element. Represents product structure itself. Files cannot be stored here
item.setPreview("");

V_nodus nodus = new V_nodus();
nodus.setVersion("");

V_pbs pbsTop = new V_pbs(); // object that represents Product Breakdown Structure.
pbsTop.setNodus(nodus);
nodus.setItem(item);
pbsTop = simDmService.pbs_create(sessionID, pbsTop); // pbsTop will obtain additional metadata generated by PLM server
```

**V_pbs** object can be considered as a storage for product structure metadata: persons, organizations, approvals, properties, etc.

Just created V_pbs object will have one single person (**V_person**) that represents PLM user who performed **pbs_create** execution.

### Properties

Product structure may have user defined properties. And values can be assigned to folders.
Property (property definition) reside in **V_pbs** object.

Available property (definitions) can be retrieved in the following way

```Java
V_pbs pbsTop = ...
V_property[] properties = simDmService.property_list(sessionID, pbsTop.getProperties());
```

Property (definition) can be created.

```Java
V_item item = new V_item();
item.setItem_type("DOUBLE_PROPERTY"); // possible values can be got from here: simDmService.property_list_types(sessionID);
item.setName("direction");
item.setDescription("...");

V_property property = new V_property();
property.setItem(item);
// folders of what types can have property assignment
property.setApplicable_to(new String[] {"ANALYSIS", "DESIGN"}); // possible values can be got from here: simDmService.node_list_types(sessionID, 0); 
property.setDefault_value(null); // should be set for mandatory properties
// the property describes 3d vector
property.setHigh_dimension(3);
property.setLow_dimension(3);
property.setMandatory(false); // optional property.
property.setScalar(false); // property describes vector value
property.setUnits(null);
property = simDmService.property_create(sessionID, property);
```

Property definition can be updated or deleted

- property_update
- property_cancel

Note, property (definition) can be deleted completely from product structure only if there is no any assignment to any folder.
Otherwise property will be market as "cancelled". And there will not be possible to make new assignments.

### Folder

Product structure can be considered as folder structure.
Let's assume **V_pbs** was already created before. But we do not have the object yet.
First folder should be connected to **V_pbs** object.

```Java
V_pbs pbsTop = simDmService.pbs_get(sessionID, null);

V_item item = new V_item();
item.setName("folder name");
item.setItem_type("DESIGN"); // can be one from list: simDmService.node_list_types(sessionID, 0 /* the value is not used */);
item.setDescription("description text");
item.setIntroduced("");
item.setLast_changed("");
item.setPreview("");

V_nodus nodus = new V_nodus();
nodus.setItem(item);
nodus.setVersion("1");

V_node node = new V_node();
node.setNodus(nodus);
node.setId("global unique identifier");
node.setRealization("");

long parent = pbsTop.getNodus().getItem().getInstance_id();
node = simDmService.node_create(sessionID, node, new long[]{ parent });
```

Second folder can be created as child of first folder.
Folder (node) may have multiple parents. And that is first difference from normal folder structure.

Folder may have multiple children folders and files (**V_attached_file**).
When folder is not needed, the one can be deleted with all its content.

### Folder version

Folder may have multiple versions with different version tags.
Each version may have same or different children folders. The same or different files may be attached to folder versions.

Let's assume **V_pbs** was already created before. and it has at least one folder.

```Java
V_pbs pbs = ...
V_node[] list = simDmService.node_list(sessionID, pbs.getNodus().getNodes());
V_node node = list[0];

long nodeId = pbs.getNodus().getNodes()[0];
V_node version = simDmService.node_create_version(sessionID, nodeId, "v. 2", true, true, true, true, false, true, false, false, false, null, null, null);
```

According to input parameters new folder version will have the same children folders. That is, children folder will be reused among two parent versions.
New folder version will have copy of all files.

### Handle files

Folder (version) may have multiple files attached.
File can be attached to a specified folder as a sequence of few methods.
Let's suppose we have file named "ULG_Coarse.stp" somewhere in a local folder.

```Java
V_item item = new V_item();
item.setName("ULG_Coarse"); // without file extension
item.setItem_type(""); // item type can be evaluated by PLM server after content is uploaded.
item.setDescription("");
item.setIntroduced("");
item.setLast_changed("");
item.setPreview("");

V_file fileSpec = new V_file();
fileSpec.setItem(item);
fileSpec.setExtension(".stp"); // file extension
fileSpec.set_interface("Interface specifications"/* any human readable text */);
fileSpec.setOriginal_name("absolute path to ULG_Coarse.stp");
fileSpec.setOriginal_format("file format name"); // can be derived from file name by using System API
fileSpec.setOS("Microsoft Windows"/* any text */);
fileSpec.setProduced_by("EPM Thechnology AS");
fileSpec.setSize(0); // size will be evaluated on server
fileSpec.setOwner(0); // organization id
fileSpec.setCheck_sum("");
fileSpec.setLink("");
fileSpec.setExpress_schema("");
fileSpec.setModel_name("");

fileSpec = simDmService.file_create(sessionID, fileSpec);
```

Consider **V_file** object as file storage in PLM database.

```Java
V_node node = ...
V_file fileSpec = ...

V_attached_file attachedFile = new V_attached_file();
V_item item = new V_item();
item.setItem_type("");
item.setDescription("");
item.setIntroduced("");
item.setLast_changed("");
item.setPreview("");
item.setName("ULG_Coarse.stp"); // file name
item.setDescription("description must be here");
attachedFile.setItem(item);
attachedFile.setDomain(node.getItem().getInstance_id());
attachedFile.setFile(fileSpec.getItem().getInstance_id());

attachedFile = simDmService.attached_file_create(sessionID, attachedFile);
```

Now file content should be uploaded to a server temporary storage

```Java
FileTransferInfo transferInfo = edmAccessControl.createTemporaryFile(sessionId, "name", ".stp", true);
```

Object **transferInfo** has info about URL to be used as target for POST request.

```Java
HttpClient client = new HttpClient();
// URL has not valid symbols. It must be encoded
String encUploadOrDownloadUrl = encodeUrl(transferInfo.getUploadOrDownloadUrl()) + sessionId;

PostMethod pm = new PostMethod(encUploadOrDownloadUrl);
File f = new File("path to ULG_Coarse.stp");
pm.setRequestHeader("Content-Type", "xxx.xxx");
pm.setRequestHeader("Content-Length", "" + f.length());
pm.setRequestEntity(new FileRequestEntity(f));
/* int status = */
client.executeMethod(pm);
/* String response = */
pm.getResponseBodyAsStream();
```

And final method is to put file from temporary storage to PLM database.

```Java
V_file fileSpec = ...
FileTransferInfo transferInfo = ...

fileSpec = simDmService.file_body_set(sessionID, fileSpec.getItem().getInstance_id(), fileSpec.getSize(), transferInfo.getFileNameOnServer());
```

### Assign property value

Folder may have multiple assigned properties, that is, property values may be assigned to a folder.
There can be only one value of a specific property (definition) assigned to a specific folder.

```Java
V_property property = ...
V_node node = ...

V_assigned_property ass = new V_assigned_property();
ass.setItem(new V_item());
ass.setDomain(parentNode.getNodus().getItem().getInstance_id());
ass.setAssignment(property.getItem().getInstance_id());
ass.setValues(new String[] {"1.23", "3.45", "0.0"}); // vector of three string values. each represents double value
        
ass = simDmService.assigned_property_create(sessionID, ass);
```